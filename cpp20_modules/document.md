---
title: C++20 Modules
author: onihusube
date: 2020/01/05
geometry:
  width: 154cm
  height: 216cm
  margin: 1in
okuduke:
  revision: 初版
  printing: ねこのしっぽ
---
\clearpage

# はじめに

## 本書の内容について

　本書ではC++20のモジュール仕様について、規格書の文面から読み取ることのできる理論的な部分を解説しています。従って、規格書では触れられていないビルドについてや`.dll, .lib, .so, .a`などの特殊な翻訳単位については触れていません。また、どう使うかよりはどういうものかのような理論的な側面を追求しているので、必ずしも実使用に当たって参考になるものではないかもしれません。

　なお、本書執筆時点では完全にモジュールを実装した処理系は存在していないため、本書の内容は実装に裏打ちされたものではなく、あくまで規格書から読み取った理論的なものにとどまります。その解釈にはおそらくいくつか間違いがあるかと思われます、ご了承ください。

　また、紙面の都合から下記の知っておいた方が良いと思われるトピックについては解説していません。分からない単語や概念に出くわしたら適宜調べてみることをお勧めします。

- 翻訳単位
- ヘッダファイルと`#include`
- 分割コンパイル
- 翻訳単位越え
- リンケージ
- テンプレートのインスタンス化
- One Difinition Rule (ODR)とその例外
- ３種類の名前探索
- 宣言と定義
- `inline`

## モジュールとは？

　モジュールとは、簡単に言えば従来のヘッダファイルとそのインクルードによるライブラリの導入を置き換えるシステムです。外部ライブラリの導入をモジュールのインポートによって、自作ライブラリでは公開したいものだけをエクスポートすることによって、C++プログラムにおけるライブラリを使用・作成します。他の言語ではパッケージとかクレートとか呼ばれているものに相当し、より効率的なプログラムの分割・導入を可能にする仕組みです。

　従来のC++にはこのような仕組みはなく、ライブラリの使用・配布はもっぱらビルド済みバイナリとヘッダーファイルの組み合わせや、ヘッダオンリーライブラリによって行われています。それらライブラリの使用時は、ライブラリの指定するヘッダーファイルを使用したい翻訳単位でインクルードすることによってライブラリのインターフェースにアクセスできるようにします。

　しかし、インクルードはC言語より引き継いだ古式ゆかしいシステムで、その実態はファイルのコピーアンドペーストであり、それにはいくつかの問題があります。

- 公開するものとしないものを選べない
    - 特に、マクロは名前空間を持たないので、一方的にばら撒かれる
- 翻訳単位ごとに同じヘッダをインクルードしていると、無駄にビルド時間が増大する
- 思わぬ多重定義によるODR違反を引き起こしやすい
- ヘッダファイルと実装が別れている場合、それらが一致せずに未定義動作に陥る可能性がある

　もちろんインクルードにもメリットや便利なところもあるのですが、ライブラリの作成・配布という観点からは適切な仕組みであるとは言えません。他の言語はより高級なライブラリ管理のシステム（モジュールシステムだけではなく、パッケージマネージャも含めて）を持っており、C++にも渇望された結果、C++20にてモジュールが導入されるに至りました。

　上記で挙げたような問題はモジュールにおいては起こらないか、軽減されています。

## 言葉の前方宣言

　モジュールの説明ではどうしてもいくつか特有の言葉を導入しなければならず、しかもそれが前後しがちなので、事前に簡単かつ順番に言葉を定義しておきます。

一部の言葉は後で詳細に説明されます。

### モジュール宣言（*module decralation*）

　ある翻訳単位をモジュールを記述するものとして表明する宣言文。`export module modulename;`もしくは`module modulename;`のような宣言。

### モジュール単位（*module unit*）

　モジュール宣言を含む翻訳単位。

### モジュール名（*module name*）

　モジュール宣言において指定した名前。1つの名前を複数のモジュール単位で共有できる。

### ヘッダーユニット（*header unit*）

　従来のヘッダファイルを仮想的にモジュール単位として扱う仕組み、もしくはその場合のモジュール単位のこと。指定されたヘッダファイル1つで1つの翻訳単位をなす。

### 名前付きモジュール（*named module*）

　同じモジュール名を持つモジュール単位の集合。名前付きモジュールが1つのモジュールとなる。

ヘッダーユニットは名前付きモジュールではない（モジュール宣言によってモジュールとなるわけではないため）。

### エンティティ

　クラス、関数、変数など、C++コード上で名前を持つことができ、何かしらの意味論を持つものの総称。本書では主に、名前空間スコープに宣言できるものを対象にしている。

### エクスポート（`export`）

　あるモジュールのエンティティを、そのモジュール外部から使用できるようにするために、`export`を付加した宣言を行うこと。

### モジュールのインターフェース

　ある名前付きモジュールにおいて、モジュール宣言に`export`を含むモジュール単位の集合、もしくはそこでエクスポートされている宣言の集合。

### グローバルモジュールフラグメント

　あるモジュール単位において、モジュール宣言より前に`module;`というマーカーを置いた時、そこからモジュール宣言の直前までの領域の事。そこはモジュールには含まれない。

　グローバルモジュールフラグメントには直接的にはプリプロセッサディレクティブしか現れてはならない。

### グローバルモジュール

　グローバルモジュールフラグメントと全てのモジュール単位ではない翻訳単位の集合。

### モジュール単位の本文（*module unit purview*）

　モジュール宣言から始まりその翻訳単位の終わり（実質的にそのファイル末尾）までの部分に書かれている文字列。名前付きモジュールの本文とは、名前付きモジュールを構成する個々のモジュールの本文の集合。

　モジュール宣言から始まるため、グローバルモジュールフラグメントはモジュールの本文には含まれない。

　グローバルモジュールの本文とは、グローバルモジュールに現れている宣言全てのこと（グローバルモジュールフラグメントも含む）。

### モジュールに属する（*attached*）

　名前付きモジュールの本文内に書かれた宣言は全て、そのモジュールに属している。

　そうでないもの（グローバルモジュールフラグメント内宣言等）は、グローバルモジュールに属している。

### 可視（*visible*）

　名前探索においてエンティティの名前が見つかる場合、その名前は名前探索において可視であるという。

### 意味論的な性質（*semantic property*）

　あるエンティティの宣言もしくは翻訳単位の、C++コードとしての機能や性質のこと。宣言等は、意味論的な性質を利用可能となって初めてC++コード上で意味を持つ。

### 到達可能（*reachable*）

　あるソースコード上の一点から、ある宣言・翻訳単位の意味論的な性質を利用可能であるとき、その点からはそのような宣言・翻訳単位は到達可能であるという。

　あるいは、ある点からある宣言等へ到達可能であるとき、その宣言等の意味論的な性質を利用可能となる。

### インポート（`import`）

　ある翻訳単位でモジュールを利用するために`import`宣言を行うこと。モジュールをインポートすることによってその翻訳単位内からは、そのモジュールのインターフェースに含まれる宣言が全て到達可能になり、`export`されている宣言が可視になる。

### 再エクスポート（`export import`）

　モジュール内部において、他のモジュールをインポートすると同時にエクスポートすること。`export import modulename;`という宣言によって行われる。あるモジュール`A`で再エクスポートされているモジュールは、`A`内でインポートしたことになると同時に、`A`をインポートした翻訳単位でもインポートしたことになる。

\clearpage

# モジュールの基本

## モジュールのインターフェース

## モジュールの実装

## パーティション

# 可視・到達可能

# モジュールとODR

# `export`

# `import`

# 変なモジュール

## グローバルモジュール

### グローバルモジュールフラグメント

## ヘッダーユニット

### `#include`からの置換

## プライベートモジュールフラグメント（単一ファイルのモジュール）

# モジュールと`inline`

# モジュールとテンプレート

# ADL

\clearpage

# 謝辞

　本書を執筆するに当たっては、cpprefjp(https://cpprefjp.github.io/ : ライセンスはCC-BY 3.0に基づく)をとても参照しました。サイト管理者及び編集者の方々に厚く御礼申し上げます。
